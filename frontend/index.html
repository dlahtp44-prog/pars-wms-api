<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PARS WMS QR BUTTON FINAL (ê¸°ëŠ¥ ìˆ˜ì • ì™„ë£Œ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      --bg: #020617;
      --accent: #2563eb;
      --accent-soft: #1d4ed8;
      --card: #0b1120;
      --border: #1f2937;
      --text: #e5e7eb;
      --nav-width: 130px; /* ë©”ë‰´ë°” ë„ˆë¹„ ì¶”ê°€ */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      /* body ì „ì²´ì— ë¯¸ë‹ˆë©ˆ ë†’ì´ë¥¼ ì¤˜ì„œ nav ì˜ì—­ì„ í™•ë³´ */
      min-height: 100vh;
      display: flex; /* í—¤ë”ì™€ ì•± ì»¨í…Œì´ë„ˆë¥¼ ì„¸ë¡œë¡œ ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
      flex-direction: column;
    }
    header {
      background: linear-gradient(90deg, #020617, #1d4ed8);
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      /* í—¤ë”ëŠ” ì „ì²´ ë„ˆë¹„ë¥¼ ì‚¬ìš© */
      flex-shrink: 0; 
    }
    header .title { font-weight: 700; font-size: 16px; }
    header .subtitle { font-size: 11px; opacity: 0.8; }
    
    /* ì „ì²´ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ: navì™€ mainì„ ê°€ë¡œë¡œ ë¶„í•  */
    #app-container {
      display: flex;
      flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
      width: 100%;
    }

    /* ì™¼ìª½ ì„¸ë¡œ ë©”ë‰´ë°” ìŠ¤íƒ€ì¼ */
    nav {
      width: var(--nav-width);
      flex-shrink: 0; /* ë„ˆë¹„ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ê³ ì • */
      display: flex;
      flex-direction: column; /* ë²„íŠ¼ ì„¸ë¡œ ì •ë ¬ */
      gap: 2px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ì¤„ì„ */
      padding: 10px 6px;
      background: #0b1120; /* ë©”ë‰´ ë°°ê²½ìƒ‰ */
      border-right: 1px solid var(--border);
      overflow-y: auto; /* ë©”ë‰´ê°€ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    }
    nav button {
      border: 0;
      border-radius: 6px; /* ë‘¥ê·¼ ëª¨ì–‘ ë³€ê²½ */
      padding: 8px 6px;
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      white-space: normal; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    nav button.active {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
    }
    nav button:hover:not(.active) {
      background: #1f2937;
    }
    
    /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ ìŠ¤íƒ€ì¼ */
    main {
      flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
      padding: 10px;
      /* ëª¨ë°”ì¼ í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬ ìµœëŒ€ ë„ˆë¹„ëŠ” ì œê±° */
      max-width: calc(100vw - var(--nav-width)); /* nav ì˜ì—­ ì œì™¸ ìµœëŒ€ ë„ˆë¹„ */
      overflow-y: auto;
    }
    
    .section { display: none; }
    .section.active { display: block; }

    .card {
      background: var(--card);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 4px rgba(15,23,42,.4);
    }
    .card h2 { margin: 0 0 6px 0; font-size: 15px; }
    .status {
      font-size: 11px;
      margin-top: 4px;
      color: #9ca3af;
    }
    .form-row {
      display: flex;
      flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ ìœ ì§€ */
      gap: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      font-size: 11px;
    }
    .field span { margin-bottom: 2px; color:#9ca3af; }
    input, select, textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      font-size: 12px;
      background: #020617;
      color: #e5e7eb;
    }
    input:disabled, textarea:disabled {
      background:#111827;
    }
    textarea { resize: vertical; min-height: 60px; }

    .btn {
      border-radius: 999px;
      border: 0;
      padding: 7px 12px;
      font-size: 12px;
      background: var(--accent);
      color:#fff;
      margin-top: 6px;
      cursor:pointer;
    }
    .btn.secondary { background:#111827; }
    .btn.sm { padding:4px 10px;font-size:11px; }

    .btn-group {
      display: flex;
      gap: 5px;
      margin-top: 6px;
    }
    .btn-group .btn {
      margin-top: 0;
      flex-grow: 1;
    }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    table {
      width:100%; border-collapse:collapse; font-size:11px; margin-top:6px;
    }
    th,td { border:1px solid #1f2937; padding:4px; text-align:center; }
    th { background:#111827; }
    .filter-group {
      display: flex; gap: 8px; margin-bottom: 8px;
    }
    .filter-group .field { flex-grow: 1; }
    .filter-group .field.w100 { flex-grow: 0; width: 100px; }


    /* QR ìŠ¤ìº” ê´€ë ¨ */
    video {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background:#000;
      margin-top:6px;
    }
    canvas.qr-preview {
      background:#fff;
      padding:4px;
      border-radius:6px;
      margin:4px;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ì„ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ëŠ” ì œê±°í•˜ê³ , ì£¼ ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ëŒ€ì²´ */
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">PARS WMS</div>
    <div class="subtitle">ë²„íŠ¼í˜• + QR + Location Excel</div>
  </div>
  <div style="font-size:11px;opacity:.8;">vQR-BUTTON-FIXED</div>
</header>

<div id="app-container">
  <nav>
    <button id="tab-dashboard" onclick="openTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
    <button id="tab-inbound" onclick="openTab('inbound')">ğŸ“¦ ì…ê³ (QR)</button>
    <button id="tab-outbound" onclick="openTab('outbound')">ğŸšš ì¶œê³ (QR)</button>
    <button id="tab-move" onclick="openTab('move')">ğŸ”„ ì´ë™(QR)</button>
    <button id="tab-opening" onclick="openTab('opening')">ğŸ“Œ ê¸°ì´ˆ</button>
    <button id="tab-location" onclick="openTab('location')">ğŸ“ Location</button>
    <button id="tab-inventory" onclick="openTab('inventory')">ğŸ“¦ ì¬ê³ </button>
    <button id="tab-history" onclick="openTab('history')">ğŸ§¾ ì´ë ¥/ì·¨ì†Œ</button>
    <button id="tab-upload" onclick="openTab('upload')">ğŸ“¥ ì—‘ì…€ & QR ì„¼í„°</button>
  </nav>

  <main>
    <section id="dashboard" class="section active">
      <div class="card">
        <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
        <p class="status">ìš”ì•½ ì •ë³´ëŠ” ì¶”í›„ í™•ì¥ ì˜ˆì •ì…ë‹ˆë‹¤. í˜„ì¬ëŠ” ë©”ë‰´ë³„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
      </div>
    </section>

    <section id="inbound" class="section">
      <div class="card">
        <h2>ğŸ“¦ ì…ê³  (í’ˆëª… ìë™ + ì¬ê³  ê¸°ë°˜ ë“œë¡­ë‹¤ìš´)</h2>
        <div class="form-row">
          <div class="field">
            <span>í’ˆë²ˆ</span>
            <input id="in_item_code" placeholder="í’ˆë²ˆ ìŠ¤ìº”/ì…ë ¥" onchange="handleItemCodeChange(this, 'in')" />
          </div>
          <div class="field">
            <span>í’ˆëª…</span>
            <input id="in_item_name" placeholder="ìë™ í‘œì‹œ ë˜ëŠ” ìˆ˜ê¸° ì…ë ¥"  />
          </div>
          <div class="field">
            <span>ì°½ê³ </span>
            <select id="in_wh" placeholder="ì°½ê³  ì„ íƒ"></select>
          </div>
          <div class="field">
            <span>Location</span>
            <select id="in_loc" placeholder="ë¡œì¼€ì´ì…˜ ì„ íƒ"></select>
          </div>
          <div class="field">
            <span>LOT (ìˆ˜ê¸° ì…ë ¥ ê°€ëŠ¥)</span>
            <input id="in_lot" placeholder="LOT No. ìˆ˜ê¸° ì…ë ¥" />
          </div>
          <div class="field">
            <span>ìˆ˜ëŸ‰</span>
            <input id="in_qty" type="number" value="1" min="1" />
          </div>
          <div class="field">
            <span>ë¹„ê³ </span>
            <input id="in_remark" placeholder="ë¹„ê³ " value="ì…ê³ " />
          </div>
        </div>
        <button class="btn" onclick="doInbound()">ì…ê³  ì²˜ë¦¬</button>
        <div class="status" id="in_result"></div>
      </div>

      <div class="card">
        <h2>ğŸ“· ì…ê³  QR ìŠ¤ìº”</h2>
        <p class="status">ì˜ˆ: ITEM=FM028CRN;WH=ì„œì´ì²œì°½ê³ ;LOC=D01-01;LOT=ORIGIN;QTY=10</p>
        <div class="btn-group">
          <button class="btn secondary sm" onclick="startQrScan('in')">QR ìŠ¤ìº” ì‹œì‘</button>
          <button class="btn secondary sm" onclick="stopQrScan()">ìŠ¤ìº” ì¤‘ì§€</button>
        </div>
        <video id="qrVideoIn" autoplay playsinline muted></video>
        <canvas id="qrCanvas" style="display:none;"></canvas>
        <div class="status" id="qrStatus">ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...</div>
      </div>
    </section>

    <section id="outbound" class="section">
      <div class="card">
        <h2>ğŸšš ì¶œê³  (í’ˆëª… ìë™ + ì¬ê³  ê¸°ë°˜ ë“œë¡­ë‹¤ìš´)</h2>
        <div class="form-row">
          <div class="field">
            <span>í’ˆë²ˆ</span>
            <input id="out_item_code" placeholder="í’ˆë²ˆ ì…ë ¥" onchange="handleItemCodeChange(this, 'out')" />
          </div>
          <div class="field">
            <span>í’ˆëª…</span>
            <input id="out_item_name"  />
          </div>
          <div class="field">
            <span>ì°½ê³ </span>
            <select id="out_wh" placeholder="ì¶œê³  ì°½ê³ "></select>
          </div>
          <div class="field">
            <span>Location</span>
            <select id="out_loc" placeholder="ì¶œê³  Location"></select>
          </div>
          <div class="field">
            <span>LOT</span>
            <select id="out_lot" placeholder="ì¶œê³  LOT"></select>
          </div>
          <div class="field">
            <span>ì¶œê³  ìˆ˜ëŸ‰</span>
            <input id="out_qty" type="number" value="1" min="1" />
          </div>
          <div class="field">
            <span>ë¹„ê³ </span>
            <input id="out_remark" value="ì¶œê³ " />
          </div>
          <div class="field">
            <span>í•´ë‹¹ LOT í˜„ì¬ê³ </span>
            <input id="out_current" disabled />
          </div>
        </div>
        <button class="btn" onclick="doOutbound()">ì¶œê³  ì²˜ë¦¬</button>
        <div class="status" id="out_result"></div>
      </div>

      <div class="card">
        <h2>ğŸ“· ì¶œê³  QR ìŠ¤ìº”</h2>
        <p class="status">ì˜ˆ: ITEM=FM028CRN;WH=ì„œì´ì²œì°½ê³ ;LOC=D01-01;LOT=ORIGIN;QTY=1</p>
        <div class="btn-group">
          <button class="btn secondary sm" onclick="startQrScan('out')">QR ìŠ¤ìº” ì‹œì‘</button>
          <button class="btn secondary sm" onclick="stopQrScan()">ìŠ¤ìº” ì¤‘ì§€</button>
        </div>
        <video id="qrVideoOut" autoplay playsinline muted></video>
        <div class="status" id="qrStatusOut">ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...</div>
      </div>
    </section>

    <section id="move" class="section">
      <div class="card">
        <h2>ğŸ”„ ì¬ê³  ì´ë™ (í’ˆëª… ìë™ + ì¬ê³  ê¸°ë°˜ ë“œë¡­ë‹¤ìš´)</h2>
        <div class="form-row">
          <div class="field">
            <span>í’ˆë²ˆ</span>
            <input id="mv_item_code" placeholder="í’ˆë²ˆ ì…ë ¥" onchange="handleItemCodeChange(this, 'move')" />
          </div>
          <div class="field">
            <span>í’ˆëª…</span>
            <input id="mv_item_name"  />
          </div>
          <h3>ì¶œê³ ì§€ (FROM)</h3>
          <div class="field"><span>ì¶œê³  ì°½ê³ </span><select id="mv_wh_from"></select></div>
          <div class="field"><span>ì¶œê³  Location</span><select id="mv_loc_from"></select></div>
          <div class="field"><span>LOT</span><select id="mv_lot"></select></div>
          <h3>ì…ê³ ì§€ (TO)</h3>
          <div class="field"><span>ì…ê³  ì°½ê³ </span><input id="mv_wh_to" /></div> 
          <div class="field"><span>ì…ê³  Location</span><input id="mv_loc_to" /></div>
          
          <div class="field"><span>ìˆ˜ëŸ‰</span><input id="mv_qty" type="number" value="1" min="1" /></div>
          <div class="field"><span>ë¹„ê³ </span><input id="mv_remark" value="ì¬ê³  ì´ë™" /></div>
        </div>
        <button class="btn" onclick="doMove()">ì´ë™ ì²˜ë¦¬</button>
        <div class="status" id="mv_result"></div>
      </div>

      <div class="card">
        <h2>ğŸ“· ì´ë™ QR ìŠ¤ìº”</h2>
        <p class="status"> ì˜ˆ: ITEM=FM028CRN;LOT=ORIGIN;WHF=ì„œì´ì²œì°½ê³ ;LOCF=D01-01;WHT=ì„œì´ì²œì°½ê³ ;LOCT=D01-02;QTY=5 </p>
        <div class="btn-group">
          <button class="btn secondary sm" onclick="startQrScan('move')">QR ìŠ¤ìº” ì‹œì‘</button>
          <button class="btn secondary sm" onclick="stopQrScan()">ìŠ¤ìº” ì¤‘ì§€</button>
        </div>
        <video id="qrVideoMove" autoplay playsinline muted></video>
        <div class="status" id="qrStatusMove">ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...</div>
      </div>
    </section>

    <section id="opening" class="section">
      <div class="card">
        <h2>ğŸ“Œ ê¸°ì´ˆ ì¬ê³  ë“±ë¡</h2>
        <div class="form-row">
          <div class="field"><span>í’ˆë²ˆ</span><input id="op_item_code" /></div>
          <div class="field"><span>í’ˆëª…</span><input id="op_item_name" /></div>
          <div class="field"><span>ì°½ê³ </span><input id="op_wh" /></div>
          <div class="field"><span>Location</span><input id="op_loc" /></div>
          <div class="field"><span>LOT</span><input id="op_lot" /></div>
          <div class="field"><span>ìˆ˜ëŸ‰</span><input id="op_qty" type="number" value="1" min="0" /></div>
          <div class="field"><span>ë¹„ê³ </span><input id="op_remark" value="ê¸°ì´ˆ ì¬ê³ " /></div>
        </div>
        <button class="btn" onclick="doOpening()">ê¸°ì´ˆ ì¬ê³  ë“±ë¡</button>
        <div class="status" id="op_result"></div>
      </div>
    </section>

    <section id="location" class="section">
      <div class="card">
        <h2>ğŸ“ Location ë§ˆìŠ¤í„°</h2>
        <div class="form-row">
          <div class="field"><span>ì°½ê³ </span><input id="loc_wh" /></div>
          <div class="field"><span>Location</span><input id="loc_loc" /></div>
        </div>
        <button class="btn" onclick="doLocationAdd()">Location ì¶”ê°€</button>
        <div class="status" id="loc_result"></div>
      </div>

      <div class="card">
        <h2>ë§ˆìŠ¤í„° ëª©ë¡</h2>
        <div class="status" id="loc_list">Location ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </section>

    <section id="inventory" class="section">
      <div class="card">
        <h2>ğŸ“¦ ì¬ê³  ì¡°íšŒ</h2>
        <div class="filter-group">
          <div class="field"><input id="inv_item_code" placeholder="í’ˆë²ˆ ê²€ìƒ‰" /></div>
          <div class="field"><input id="inv_lot_no" placeholder="LOT ê²€ìƒ‰" /></div>
          <div class="field"><input id="inv_wh" placeholder="ì°½ê³  ê²€ìƒ‰" /></div>
          <div class="field"><input id="inv_loc" placeholder="Location ê²€ìƒ‰" /></div>
        </div>
        <div class="filter-group">
          <div class="field"><input id="inv_from" type="date" placeholder="ê±°ë˜ ì‹œì‘ì¼" /></div>
          <div class="field"><input id="inv_to" type="date" placeholder="ê±°ë˜ ì¢…ë£Œì¼" /></div>
          <button class="btn sm" onclick="loadInventoryFiltered()">ê²€ìƒ‰</button>
          <button class="btn sm secondary" onclick="loadInventory()">ì „ì²´</button>
        </div>
        <div class="status" id="inv_table">ì¬ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </section>

    <section id="history" class="section">
      <div class="card">
        <h2>ğŸ§¾ ì¬ê³  ì´ë ¥/ì·¨ì†Œ</h2>
        <div class="filter-group">
          <div class="field"><select id="his_type"><option value="">TYPE</option><option value="IN">IN</option><option value="OUT">OUT</option><option value="MOVE">MOVE</option><option value="OPENING">OPENING</option><option value="ROLLBACK">ROLLBACK</option></select></div>
          <div class="field"><input id="his_item_code" placeholder="í’ˆë²ˆ ê²€ìƒ‰" /></div>
          <div class="field"><input id="his_lot_no" placeholder="LOT ê²€ìƒ‰" /></div>
        </div>
        <div class="filter-group">
          <div class="field"><input id="his_wh" placeholder="ì°½ê³  ê²€ìƒ‰" /></div>
          <div class="field"><input id="his_loc" placeholder="Location ê²€ìƒ‰" /></div>
          <div class="field"><input id="his_from" type="date" placeholder="ê±°ë˜ ì‹œì‘ì¼" /></div>
          <div class="field"><input id="his_to" type="date" placeholder="ê±°ë˜ ì¢…ë£Œì¼" /></div>
          <button class="btn sm" onclick="loadHistoryFiltered()">ê²€ìƒ‰</button>
          <button class="btn sm secondary" onclick="loadHistory()">ì „ì²´</button>
        </div>
        <div class="status" id="his_table">ì´ë ¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </section>

    <section id="upload" class="section">
      <div class="card">
        <h2>ğŸ“¥ ì—‘ì…€ ì—…ë¡œë“œ</h2>
        <p class="status">í•„ìˆ˜ ì»¬ëŸ¼ ìˆœì„œ (HeaderëŠ” ë¬´ì‹œë¨):<br/>
          ì…ê³ /ì¶œê³ : ì°½ê³ , Location, í’ˆë²ˆ, í’ˆëª…, LOT, ìˆ˜ëŸ‰, ë¹„ê³ <br/>
          ì´ë™: ì¶œê³ ì°½ê³ , ì¶œê³ Loc, ì…ê³ ì°½ê³ , ì…ê³ Loc, í’ˆë²ˆ, LOT, ìˆ˜ëŸ‰, ë¹„ê³ <br/>
          ê¸°ì´ˆ: ì°½ê³ , Location, í’ˆë²ˆ, í’ˆëª…, LOT, ìˆ˜ëŸ‰, ë¹„ê³ <br/>
          Location: ì°½ê³ , Location
        </p>
        <div class="form-row">
          <div class="field"> <span>ì…ê³  ì—…ë¡œë“œ</span> <input type="file" id="file_inbound" accept=".xlsx,.xlsm" /> </div>
          <button class="btn sm" onclick="uploadExcel('inbound')">ì…ê³  ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="form-row">
          <div class="field"> <span>ì¶œê³  ì—…ë¡œë“œ</span> <input type="file" id="file_outbound" accept=".xlsx,.xlsm" /> </div>
          <button class="btn sm" onclick="uploadExcel('outbound')">ì¶œê³  ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="form-row">
          <div class="field"> <span>ì´ë™ ì—…ë¡œë“œ</span> <input type="file" id="file_move" accept=".xlsx,.xlsm" /> </div>
          <button class="btn sm" onclick="uploadExcel('move')">ì´ë™ ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="form-row">
          <div class="field"> <span>ê¸°ì´ˆì¬ê³  ì—…ë¡œë“œ</span> <input type="file" id="file_opening" accept=".xlsx,.xlsm" /> </div>
          <button class="btn sm" onclick="uploadExcel('opening')">ê¸°ì´ˆ ì¬ê³  ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="form-row">
          <div class="field"> <span>Location ì—…ë¡œë“œ</span> <input type="file" id="file_location" accept=".xlsx,.xlsm" /> </div>
          <button class="btn sm" onclick="uploadExcel('location')">Location ì—‘ì…€ ì—…ë¡œë“œ</button>
        </div>
        <div class="status" id="upload_result"></div>
      </div>

      <div class="card">
        <h2>ğŸ“° QR ìƒì„±</h2>
        <div class="form-row">
          <div class="field"><span>QR ë°ì´í„°</span><textarea id="qr_data">ITEM=FM028CRN;WH=ì„œì´ì²œì°½ê³ ;LOC=D01-01;LOT=ORIGIN;QTY=10</textarea></div>
        </div>
        <button class="btn sm" onclick="generateQR()">QR ìƒì„±</button>
        <div id="qr_display" style="text-align:center;"></div>
      </div>
    </section>
  </main>
</div>

<script>
  // ID ë‹¨ì¶•
  const in_item_code = document.getElementById("in_item_code");
  const in_item_name = document.getElementById("in_item_name");
  const in_wh = document.getElementById("in_wh");
  const in_loc = document.getElementById("in_loc");
  const in_lot = document.getElementById("in_lot"); // input
  const in_qty = document.getElementById("in_qty");
  const in_remark = document.getElementById("in_remark");

  const out_item_code = document.getElementById("out_item_code");
  const out_item_name = document.getElementById("out_item_name");
  const out_wh = document.getElementById("out_wh");
  const out_loc = document.getElementById("out_loc");
  const out_lot = document.getElementById("out_lot");
  const out_qty = document.getElementById("out_qty");
  const out_remark = document.getElementById("out_remark");

  const mv_item_code = document.getElementById("mv_item_code");
  const mv_item_name = document.getElementById("mv_item_name");
  const mv_wh_from = document.getElementById("mv_wh_from");
  const mv_loc_from = document.getElementById("mv_loc_from");
  const mv_wh_to = document.getElementById("mv_wh_to");
  const mv_loc_to = document.getElementById("mv_loc_to");
  const mv_lot = document.getElementById("mv_lot");
  const mv_qty = document.getElementById("mv_qty");
  const mv_remark = document.getElementById("mv_remark");

  const inv_item_code = document.getElementById("inv_item_code");
  const inv_lot_no = document.getElementById("inv_lot_no");
  const inv_wh = document.getElementById("inv_wh");
  const inv_loc = document.getElementById("inv_loc");
  const inv_from = document.getElementById("inv_from");
  const inv_to = document.getElementById("inv_to");

  const his_type = document.getElementById("his_type");
  const his_item_code = document.getElementById("his_item_code");
  const his_lot_no = document.getElementById("his_lot_no");
  const his_wh = document.getElementById("his_wh");
  const his_loc = document.getElementById("his_loc");
  const his_from = document.getElementById("his_from");
  const his_to = document.getElementById("his_to");


  // --- íƒ­ ê´€ë¦¬ ---
  function openTab(tabName) {
    // ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    // íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));

    // ì„ íƒëœ ì„¹ì…˜ ë³´ì´ê¸°
    document.getElementById(tabName).classList.add('active');
    // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('tab-' + tabName).classList.add('active');

    // íŠ¹ì • íƒ­ìœ¼ë¡œ ì´ë™ ì‹œ ë°ì´í„° ë¡œë“œ
    if (tabName === 'location') {
      loadLocationList();
    } else if (tabName === 'inventory') {
      loadInventory();
    } else if (tabName === 'history') {
      loadHistory();
    }
  }

  // --- API í˜¸ì¶œ ìœ í‹¸ ---
  async function callApi(url, method = "GET", payload = null) {
    const options = {
      method: method,
      headers: {
        "Content-Type": "application/json",
      },
    };
    if (payload) {
      options.body = JSON.stringify(payload);
    }
    const res = await fetch(url, options);

    if (!res.ok) {
      const t = await res.text();
      try {
        const errJson = JSON.parse(t);
        throw new Error(errJson.detail || errJson.msg || ("HTTP " + res.status));
      } catch {
        throw new Error(t || ("HTTP " + res.status));
      }
    }
    return res.json();
  }

  // --- í’ˆëª… ìë™ ì±„ì›€ ---
  async function fillItemName(codeInput, nameInput){
    const code = codeInput.value.trim();
    if(!code){
      nameInput.value="";
      return;
    }
    try{
      // ê°€ì •: /api/item_name ì—”ë“œí¬ì¸íŠ¸ëŠ” í’ˆëª… ì¡°íšŒë¥¼ ì§€ì›í•¨
      const d = await callApi("/api/item_name?item_code="+encodeURIComponent(code));
      nameInput.value = d.item_name || 'í’ˆëª… ë¯¸ë“±ë¡';
    }catch(e){
      console.error(e);
      nameInput.value = 'ì¡°íšŒ ì˜¤ë¥˜';
    }
  }

  // --- ë“œë¡­ë‹¤ìš´ ìœ í‹¸ í•¨ìˆ˜ ---
  function updateDropdown(selectElement, data, placeholderText) {
    // ê¸°ì¡´ LOT ê°’ì„ ìœ ì§€í•˜ë ¤ê³  ì‹œë„
    const currentValue = selectElement.value;

    selectElement.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = placeholderText;
    selectElement.appendChild(defaultOption);

    let isCurrentValuePresent = false;
    data.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      if (item === currentValue) {
        opt.selected = true;
        isCurrentValuePresent = true;
      }
      selectElement.appendChild(opt);
    });
    // ê¸°ì¡´ ê°’ì´ ëª©ë¡ì— ì—†ìœ¼ë©´ ì„ íƒ í•´ì œ
    if (!isCurrentValuePresent && currentValue) {
      selectElement.value = '';
    }
  }

  function clearDropdowns(...elements) {
    const last = elements[elements.length - 1];
    const placeholderText = typeof last === 'string' ? last : 'ì„ íƒí•˜ì„¸ìš”';
    
    elements.slice(0, elements.length - (typeof last === 'string' ? 1 : 0)).forEach(selectElement => {
      if (selectElement.tagName === 'SELECT') {
        selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
      }
    });
  }


  // --- ì¬ê³  í•„í„° ë“œë¡­ë‹¤ìš´ ë¡œë“œ ---
  // ì´ í•¨ìˆ˜ëŠ” ë°±ì—”ë“œ êµ¬í˜„ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤. í˜„ì¬ëŠ” ë”ë¯¸ ë¡œì§ì…ë‹ˆë‹¤.
  // ì´ í•¨ìˆ˜ì˜ ë‚´ë¶€ ë¡œì§ (getLocationsForWh, getLotsForWhLoc)ì€ ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ì •í™•íˆ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.
  async function loadInventoryFilters(code, context) {
    const defaultPlaceholder = context === 'in' ? 'ì°½ê³ /ë¡œì¼€ì´ì…˜' : 'ì°½ê³ /ë¡œì¼€ì´ì…˜/LOT';

    try {
        // ë°±ì—”ë“œ APIê°€ ì¬ê³  ê¸°ë°˜ ì°½ê³ /ë¡œì¼€ì´ì…˜/LOT ëª©ë¡ì„ ì œê³µí•œë‹¤ê³  ê°€ì •
        const result = await callApi("/api/inventory/filters?item_code=" + encodeURIComponent(code));
        
        // --- INBOUND (ì…ê³ ) ë¡œì§ ---
        if(context === 'in'){
            // ì…ê³ ëŠ” ì¬ê³  ê¸°ë°˜ í•„í„°ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ Location ë§ˆìŠ¤í„° ê¸°ë°˜ìœ¼ë¡œ ê°±ì‹ í•˜ëŠ” ê²ƒì´ ë” í•©ë¦¬ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ì˜ ì˜ë„ëŒ€ë¡œ ì¬ê³  ê¸°ë°˜ í•„í„°ë§ì„ ìœ ì§€í•©ë‹ˆë‹¤.
            updateDropdown(in_wh, result.warehouses, 'ì°½ê³  ì„ íƒ');
            updateDropdown(in_loc, result.locations, 'Location ì„ íƒ');
            // in_lotì€ inputì´ë¯€ë¡œ ì œì™¸
        } 
        
        // --- OUTBOUND (ì¶œê³ ) ë¡œì§ ---
        else if (context === 'out'){
            const invMap = result.inventory_map || {};
            
            // 1. ì´ˆê¸° ì „ì²´ ëª©ë¡ ë¡œë“œ
            updateDropdown(out_wh, result.warehouses, 'ì¶œê³  ì°½ê³  ì„ íƒ');
            updateDropdown(out_loc, result.locations, 'ì¶œê³  Location ì„ íƒ');
            updateDropdown(out_lot, result.lots, 'ì¶œê³  LOT ì„ íƒ');

            // 2. ì¢…ì†ì ì¸ ë“œë¡­ë‹¤ìš´ ë¡œì§ ì„¤ì •
            const updateOutLocAndLot = () => {
                const selectedWh = out_wh.value;
                const selectedLoc = out_loc.value;
                
                // ì°½ê³  ë³€ê²½ ì‹œ ë¡œì¼€ì´ì…˜ê³¼ LOT ê°±ì‹ 
                updateDropdown(out_loc, getLocationsForWh(selectedWh, invMap), 'ì¶œê³  Location ì„ íƒ');
                updateDropdown(out_lot, getLotsForWhLoc(selectedWh, selectedLoc, invMap), 'ì¶œê³  LOT ì„ íƒ');
                loadCurrentQty(context);
            };

            const updateOutLot = () => {
                const selectedWh = out_wh.value;
                const selectedLoc = out_loc.value;
                
                // ë¡œì¼€ì´ì…˜ ë³€ê²½ ì‹œ LOT ê°±ì‹ 
                updateDropdown(out_lot, getLotsForWhLoc(selectedWh, selectedLoc, invMap), 'ì¶œê³  LOT ì„ íƒ');
                loadCurrentQty(context);
            };

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            out_wh.onchange = updateOutLocAndLot;
            out_loc.onchange = updateOutLot;
            out_lot.onchange = () => loadCurrentQty(context);

        } 
        
        // --- MOVE (ì´ë™) ë¡œì§ ---
        else if (context === 'move'){
            const invMap = result.inventory_map || {};

            // 1. ì´ˆê¸° ì „ì²´ ëª©ë¡ ë¡œë“œ
            updateDropdown(mv_wh_from, result.warehouses, 'ì¶œê³  ì°½ê³  ì„ íƒ');
            updateDropdown(mv_loc_from, result.locations, 'ì¶œê³  Location ì„ íƒ');
            updateDropdown(mv_lot, result.lots, 'ì´ë™í•  LOT ì„ íƒ');
            // ì…ê³ ì§€(TO)ëŠ” ì…ë ¥ í•„ë“œ ìœ ì§€ 

            // 2. ì¢…ì†ì ì¸ ë“œë¡­ë‹¤ìš´ ë¡œì§ ì„¤ì •
            const updateMvLocAndLot = () => {
                const selectedWh = mv_wh_from.value;
                const selectedLoc = mv_loc_from.value;
                
                // ì°½ê³  ë³€ê²½ ì‹œ ë¡œì¼€ì´ì…˜ê³¼ LOT ê°±ì‹ 
                updateDropdown(mv_loc_from, getLocationsForWh(selectedWh, invMap), 'ì¶œê³  Location ì„ íƒ');
                updateDropdown(mv_lot, getLotsForWhLoc(selectedWh, selectedLoc, invMap), 'ì´ë™í•  LOT ì„ íƒ');
                loadCurrentQty(context);
            };

            const updateMvLot = () => {
                const selectedWh = mv_wh_from.value;
                const selectedLoc = mv_loc_from.value;
                
                // ë¡œì¼€ì´ì…˜ ë³€ê²½ ì‹œ LOT ê°±ì‹ 
                updateDropdown(mv_lot, getLotsForWhLoc(selectedWh, selectedLoc, invMap), 'ì´ë™í•  LOT ì„ íƒ');
                loadCurrentQty(context);
            };

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            mv_wh_from.onchange = updateMvLocAndLot;
            mv_loc_from.onchange = updateMvLot;
            mv_lot.onchange = () => loadCurrentQty(context);
        }

    } catch(e) {
        console.error("ì¬ê³  í•„í„°ë§ ì˜¤ë¥˜:", e);
        if(context === 'in'){
            clearDropdowns(in_wh, in_loc, defaultPlaceholder);
        } else if (context === 'out'){
            clearDropdowns(out_wh, out_loc, out_lot, defaultPlaceholder);
            document.getElementById("out_current").value = "";
        } else if (context === 'move'){
            clearDropdowns(mv_wh_from, mv_loc_from, mv_lot, defaultPlaceholder);
        }
    }
  }

  // --- ì¬ê³  ë§µ ê¸°ë°˜ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (loadInventoryFiltersì—ì„œ ì‚¬ìš©) ---
  // ë°±ì—”ë“œ APIê°€ { "ì°½ê³ ": { "ë¡œì¼€ì´ì…˜": [ "LOT1", "LOT2" ] } } í˜•íƒœì˜ ë§µì„ ì¤€ë‹¤ê³  ê°€ì •
  function getLocationsForWh(warehouse, inventoryMap) {
      if (!warehouse || !inventoryMap[warehouse]) {
          return [];
      }
      return Object.keys(inventoryMap[warehouse]);
  }

  function getLotsForWhLoc(warehouse, location, inventoryMap) {
      if (!warehouse || !location || !inventoryMap[warehouse] || !inventoryMap[warehouse][location]) {
          return [];
      }
      return inventoryMap[warehouse][location];
  }

  // --- í’ˆë²ˆ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í†µí•© ---
  function handleItemCodeChange(inputElement, context) {
    const code = inputElement.value.trim();
    let nameElement; 
    let clearFunc;

    if (context === 'in') { 
        nameElement = in_item_name; 
        clearFunc = () => clearDropdowns(in_wh, in_loc, 'ì°½ê³ /ë¡œì¼€ì´ì…˜'); 
    } else if (context === 'out') { 
        nameElement = out_item_name; 
        clearFunc = () => { clearDropdowns(out_wh, out_loc, out_lot, 'ì°½ê³ /ë¡œì¼€ì´ì…˜/LOT'); document.getElementById("out_current").value = ""; };
    } else if (context === 'move') { 
        nameElement = mv_item_name; 
        clearFunc = () => clearDropdowns(mv_wh_from, mv_loc_from, mv_lot, 'ì¶œê³ ì§€/LOT');
    }

    if(code) {
      fillItemName(inputElement, nameElement);
      loadInventoryFilters(code, context);
    } else {
      nameElement.value = "";
      clearFunc();
    }
  }


  // --- í˜„ì¬ê³  ë¡œë“œ ìœ í‹¸ (ì¶œê³ /ì´ë™ì—ì„œ ì‚¬ìš©) ---
  async function loadCurrentQty(context){
    let item_code, wh, loc, lot, qtyInput, resultBox;
    if(context === 'out'){
      item_code = out_item_code.value;
      wh = out_wh.value;
      loc = out_loc.value;
      lot = out_lot.value;
      qtyInput = document.getElementById("out_current");
      resultBox = document.getElementById("out_result");
    } else if (context === 'move'){
      item_code = mv_item_code.value;
      wh = mv_wh_from.value;
      loc = mv_loc_from.value;
      lot = mv_lot.value;
      qtyInput = document.getElementById("mv_qty"); // ì´ë™ì—ì„œëŠ” ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œì— maxë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ ì‚¬ìš©
      resultBox = document.getElementById("mv_result");
    }

    if (!item_code || !wh || !loc || !lot) {
      if(context === 'out') qtyInput.value = "";
      return;
    }

    try{
      const data = await callApi(`/api/inventory/qty?item_code=${encodeURIComponent(item_code)}&warehouse=${encodeURIComponent(wh)}&location=${encodeURIComponent(loc)}&lot_no=${encodeURIComponent(lot)}`);
      if(context === 'out'){
        qtyInput.value = data.current_qty.toFixed(2);
      } else if (context === 'move'){
        // ì´ë™ì—ì„œëŠ” ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œì˜ ìµœëŒ€ê°’ì„ ì¬ê³ ë¡œ ì œí•œí•©ë‹ˆë‹¤.
        qtyInput.setAttribute('max', data.current_qty.toFixed(2));
      }
    }catch(e){
      console.error("ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜:", e);
      if(context === 'out') qtyInput.value = "ì¡°íšŒ ì˜¤ë¥˜";
      resultBox.textContent = "ì¬ê³  ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
    }
  }


  // --- Location ê´€ë¦¬ í•¨ìˆ˜ ---
  async function doLocationAdd(){
    const payload = {
      warehouse: loc_wh.value,
      location: loc_loc.value
    };
    if (!payload.warehouse || !payload.location) {
        document.getElementById("loc_result").textContent = "ì—ëŸ¬: ì°½ê³ ì™€ Locationì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
        alert("ì—ëŸ¬: ì°½ê³ ì™€ Locationì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }
    const box = document.getElementById("loc_result");
    try{
      const data = await callApi("/api/location","POST",payload);
      box.textContent = "Location ì¶”ê°€ ì™„ë£Œ: " + data.warehouse + "/" + data.location;
      alert("ğŸ“ Location ì¶”ê°€ ì™„ë£Œ");
      loadLocationList();
    }catch(e){
      box.textContent = "ì‹¤íŒ¨: " + e.message;
      alert("âŒ Location ì¶”ê°€ ì‹¤íŒ¨: " + e.message);
    }
  }

  async function loadLocationList(){
    const box = document.getElementById("loc_list");
    box.textContent = "Location ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    try {
        const list = await callApi("/api/location");
        if(!list.length){
          box.textContent = "ë“±ë¡ëœ Location ì—†ìŒ";
          return;
        }
        
        let html = "<table><thead><tr><th>ì°½ê³ </th><th>Location</th></tr></thead><tbody>";
        list.forEach(item => {
          html += `<tr><td>${item.warehouse}</td><td>${item.location}</td></tr>`;
        });
        html += "</tbody></table>";
        box.innerHTML = html;
    } catch(e) {
        box.textContent = "Location ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: " + e.message;
    }
  }

  // --- ê±°ë˜ ì²˜ë¦¬ í•¨ìˆ˜ ---
  async function doInbound(){
    const payload = {
      item_code: in_item_code.value,
      item_name: in_item_name.value,
      warehouse: in_wh.value,
      location: in_loc.value,
      lot_no: in_lot.value,
      qty: parseFloat(in_qty.value || "0"),
      remark: in_remark.value
    };

    if (!payload.item_code || !payload.warehouse || !payload.location || !payload.lot_no || payload.qty <= 0) {
        document.getElementById("in_result").textContent = "ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.";
        alert("ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }

    const box = document.getElementById("in_result");
    try{
      const data = await callApi("/api/inventory/in","POST",payload);
      box.textContent = "ì…ê³  ì™„ë£Œ: í˜„ì¬ê³  " + data.í˜„ì¬ê³ .toFixed(2);
      alert("ğŸ“¦ ì…ê³  ì™„ë£Œ");
      // ë“œë¡­ë‹¤ìš´ ê°±ì‹  (LOTì€ ìˆ˜ë™ ì…ë ¥ì´ë¯€ë¡œ ê°±ì‹  ë¶ˆí•„ìš”)
      loadInventoryFilters(payload.item_code, 'in'); 
      loadInventory();
      loadHistory();
    }catch(e){
      box.textContent = "ì‹¤íŒ¨: " + e.message;
      alert("âŒ ì…ê³  ì‹¤íŒ¨: " + e.message);
    }
  }

  async function doOutbound(){
    const payload = {
      item_code: out_item_code.value,
      item_name: out_item_name.value,
      warehouse: out_wh.value,
      location: out_loc.value,
      lot_no: out_lot.value,
      qty: parseFloat(out_qty.value || "0"),
      remark: out_remark.value
    };

    if (!payload.item_code || !payload.warehouse || !payload.location || !payload.lot_no || payload.qty <= 0) {
        document.getElementById("out_result").textContent = "ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.";
        alert("ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }
    
    const box = document.getElementById("out_result");
    try{
      const data = await callApi("/api/inventory/out","POST",payload);
      if(data.result === "FAIL"){
        box.textContent = "ì‹¤íŒ¨: " + data.msg + " (í˜„ì¬ê³ :"+data.í˜„ì¬ê³ .toFixed(2)+")";
        alert("âŒ ì¶œê³  ì¬ê³  ë¶€ì¡±");
      }else{
        box.textContent = "ì¶œê³  ì™„ë£Œ: í˜„ì¬ê³  " + data.í˜„ì¬ê³ .toFixed(2);
        alert("ğŸšš ì¶œê³  ì™„ë£Œ");
        loadInventoryFilters(payload.item_code, 'out'); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        loadCurrentQty('out'); // í˜„ì¬ê³  ê°±ì‹ 
        loadInventory();
        loadHistory();
      }
    }catch(e){
      box.textContent = "ì‹¤íŒ¨: " + e.message;
      alert("âŒ ì¶œê³  ì‹¤íŒ¨: " + e.message);
    }
  }

  async function doMove(){
    const payload = {
      warehouse_from: mv_wh_from.value,
      location_from: mv_loc_from.value,
      warehouse_to: mv_wh_to.value,
      location_to: mv_loc_to.value,
      item_code: mv_item_code.value,
      lot_no: mv_lot.value,
      qty: parseFloat(mv_qty.value || "0"),
      remark: mv_remark.value
    };

    if (!payload.item_code || !payload.warehouse_from || !payload.location_from || !payload.warehouse_to || !payload.location_to || !payload.lot_no || payload.qty <= 0) {
        document.getElementById("mv_result").textContent = "ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.";
        alert("ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }
    
    const box = document.getElementById("mv_result");
    try{
      const data = await callApi("/api/inventory/move","POST",payload);
      if(data.result === "FAIL"){
        box.textContent = "ì‹¤íŒ¨: " + data.msg + " (í˜„ì¬ê³ :"+data.í˜„ì¬ê³ .toFixed(2)+")";
        alert("âŒ ì´ë™ ì¬ê³  ë¶€ì¡±");
      }else{
        box.textContent = "ì´ë™ ì™„ë£Œ";
        alert("ğŸ”„ ì´ë™ ì™„ë£Œ");
        loadInventoryFilters(payload.item_code, 'move'); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        loadCurrentQty('move'); // í˜„ì¬ê³  ê°±ì‹ 
        loadInventory();
        loadHistory();
      }
    }catch(e){
      box.textContent = "ì‹¤íŒ¨: " + e.message;
      alert("âŒ ì´ë™ ì‹¤íŒ¨: " + e.message);
    }
  }

  async function doOpening(){
    const payload = {
      item_code: op_item_code.value,
      item_name: op_item_name.value,
      warehouse: op_wh.value,
      location: op_loc.value,
      lot_no: op_lot.value,
      qty: parseFloat(op_qty.value || "0"),
      remark: op_remark.value
    };

    if (!payload.item_code || !payload.warehouse || !payload.location || !payload.lot_no || payload.qty <= 0) {
        document.getElementById("op_result").textContent = "ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.";
        alert("ì—ëŸ¬: í•„ìˆ˜ ì…ë ¥/ì„ íƒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }
    
    const box = document.getElementById("op_result");
    try{
      const data = await callApi("/api/inventory/opening","POST",payload);
      box.textContent = "ê¸°ì´ˆ ì¬ê³  ë“±ë¡ ì™„ë£Œ: í˜„ì¬ê³  " + data.í˜„ì¬ê³ .toFixed(2);
      alert("ğŸ“Œ ê¸°ì´ˆ ì¬ê³  ë“±ë¡ ì™„ë£Œ");
      loadInventory();
      loadHistory();
    }catch(e){
      box.textContent = "ì‹¤íŒ¨: " + e.message;
      alert("âŒ ê¸°ì´ˆ ì¬ê³  ë“±ë¡ ì‹¤íŒ¨: " + e.message);
    }
  }


  // --- ì¬ê³  ì¡°íšŒ (Inventory) ---
  async function loadInventory(){ 
    const box = document.getElementById("inv_table"); 
    box.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."; 
    try{ 
        const list = await callApi("/api/inventory"); 
        renderInventory(list); 
    }catch(e){ 
        box.textContent = "ì—ëŸ¬: " + e.message; 
    } 
  } 

  async function loadInventoryFiltered(){ 
    const box = document.getElementById("inv_table"); 
    box.textContent = "ê²€ìƒ‰ ì¤‘..."; 
    const p = new URLSearchParams({ 
        item_code: inv_item_code.value || "", 
        lot_no: inv_lot_no.value || "", 
        warehouse: inv_wh.value || "", 
        location: inv_loc.value || "", 
        date_from: inv_from.value || "", 
        date_to: inv_to.value || "" 
    }); 
    try{ 
        const list = await callApi("/api/inventory?"+p.toString()); 
        renderInventory(list); 
    }catch(e){ 
        box.textContent = "ì—ëŸ¬: " + e.message; 
    } 
  }

  function renderInventory(list){
      const box = document.getElementById("inv_table");
      if(!list.length){
          box.textContent = "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ";
          return;
      }
      
      let html = "<table><thead><tr>"+
          "<th>ì°½ê³ </th><th>Loc</th><th>í’ˆë²ˆ</th><th>í’ˆëª…</th><th>LOT</th><th>í˜„ì¬ê³ </th><th>ìµœì¢…ê±°ë˜ì‹œê°„</th>"+
          "</tr></thead><tbody>";
      
      list.forEach(item => {
          const qty_class = item.current_qty > 0 ? 'style="color:#7CFC00; font-weight: bold;"' : '';
          html += `<tr>
              <td>${item.warehouse}</td>
              <td>${item.location}</td>
              <td>${item.item_code}</td>
              <td>${item.item_name || ''}</td>
              <td>${item.lot_no}</td>
              <td ${qty_class}>${item.current_qty.toFixed(2)}</td>
              <td>${item.last_tx_time.replace("T"," ")}</td>
          </tr>`;
      });

      html += "</tbody></table>";
      box.innerHTML = html;
  }
  
  // --- ì¬ê³  ì´ë ¥ (History) ---
  async function loadHistory(){
    const his_table = document.getElementById("his_table");
    his_table.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    try{
        const list = await callApi("/api/history");
        renderHistory(list);
    }catch(e){
        his_table.textContent = "ì—ëŸ¬: " + e.message;
    }
  }

  async function loadHistoryFiltered(){
    const his_table = document.getElementById("his_table");
    his_table.textContent = "ê²€ìƒ‰ ì¤‘...";
    const p = new URLSearchParams({
        tx_type: his_type.value || "",
        item_code: his_item_code.value || "",
        lot_no: his_lot_no.value || "",
        warehouse: his_wh.value || "",
        location: his_loc.value || "",
        date_from: his_from.value || "",
        date_to: his_to.value || ""
    });
    try{
        const list = await callApi("/api/history?"+p.toString());
        renderHistory(list);
    }catch(e){
        his_table.textContent = "ì—ëŸ¬: " + e.message;
    }
  }

  function renderHistory(list){ 
      const box = document.getElementById("his_table"); 
      if(!list.length){ 
          box.textContent = "ì´ë ¥ ì—†ìŒ"; 
          return; 
      } 
      let html = "<table><thead><tr>"+ 
          "<th>ID</th><th>ì‹œê°„</th><th>TYPE</th><th>ì°½ê³ </th><th>Loc</th><th>í’ˆë²ˆ</th><th>í’ˆëª…</th><th>LOT</th><th>ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th><th>ì·¨ì†Œ</th>"+
          "</tr></thead><tbody>";
      
      list.forEach(item => {
          const tx_qty = item.qty.toFixed(2);
          const qty_class = item.qty > 0 ? 'style="color:#7CFC00; font-weight: bold;"' : (item.qty < 0 ? 'style="color:#FFA07A; font-weight: bold;"' : '');
          const item_name = item.item_name || ''; 
          
          // ROLLBACK ê±°ë˜ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ê³ , ì´ë¯¸ ì·¨ì†Œëœ ê±°ë˜ë„ ë‹¤ì‹œ ì·¨ì†Œí•  ìˆ˜ ì—†ìŒ
          const rollback_button = item.tx_type !== 'ROLLBACK' 
              ? `<button class="btn sm secondary" onclick="doRollback(${item.id})">ì·¨ì†Œ</button>` 
              : `ì·¨ì†Œë¨ (ì›ì²œ ID:${item.source_tx_id || item.id})`;

          html += `<tr>
              <td>${item.id}</td>
              <td>${item.tx_time.replace("T"," ")}</td>
              <td>${item.tx_type}</td>
              <td>${item.warehouse}</td>
              <td>${item.location}</td>
              <td>${item.item_code}</td>
              <td>${item_name}</td>
              <td>${item.lot_no}</td>
              <td ${qty_class}>${tx_qty}</td>
              <td>${item.remark || ''}</td>
              <td>${rollback_button}</td>
          </tr>`;
      });

      html += "</tbody></table>";
      box.innerHTML = html; 
  }

  async function doRollback(tx_id){
    if(!confirm(`ê±°ë˜ ID ${tx_id}ë¥¼ ì •ë§ë¡œ ì·¨ì†Œ(ë¡¤ë°±)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
        return;
    }

    const box = document.getElementById("his_table");
    box.textContent = `ê±°ë˜ ID ${tx_id} ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...`;

    try{
        const data = await callApi(`/api/inventory/rollback/${tx_id}`, "POST");
        alert(data.msg);
        loadHistory(); // ì´ë ¥ ê°±ì‹ 
        loadInventory(); // ì¬ê³  ê°±ì‹ 
    }catch(e){
        box.textContent = "ì·¨ì†Œ ì‹¤íŒ¨: " + e.message;
        alert("âŒ ì·¨ì†Œ ì‹¤íŒ¨: " + e.message);
        loadHistory(); // ì‹¤íŒ¨í•˜ë”ë¼ë„ ëª©ë¡ì€ ë‹¤ì‹œ ë¡œë“œ
    }
  }


  // --- ì—‘ì…€ ì—…ë¡œë“œ ìœ í‹¸ ---
  async function uploadExcel(kind){
    const fileInput = document.getElementById(`file_${kind}`);
    const file = fileInput.files[0];
    const box = document.getElementById("upload_result");

    if (!file) {
      box.textContent = "ì—ëŸ¬: íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.";
      alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);
    box.textContent = `${kind} ì—‘ì…€ ì—…ë¡œë“œ ì¤‘...`;

    try {
      const res = await fetch(`/api/upload/${kind}`, {
        method: 'POST',
        body: formData,
      });

      if (!res.ok) {
        const t = await res.text();
        try {
          const errJson = JSON.parse(t);
          throw new Error(errJson.detail || ("HTTP " + res.status));
        } catch {
          throw new Error(t || ("HTTP " + res.status));
        }
      }

      const data = await res.json();
      let msg = "ì—…ë¡œë“œ ì™„ë£Œ: ";
      const successCount = data.uploaded !== undefined ? data.uploaded : data.inserted;
      const failedCount = data.failed ? data.failed.length : (data.failed_rows ? data.failed_rows.length : 0);
      
      msg += "ì„±ê³µ " + (successCount || 0) + "ê±´";
      if(failedCount > 0){ 
        msg += " / ì‹¤íŒ¨ " + failedCount + "ê±´ (ìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†” í™•ì¸)"; 
      }
      box.textContent = msg;

      if(kind === "location"){
        if(typeof loadLocationList === "function") loadLocationList();
      }else if(["inbound", "outbound", "move", "opening"].includes(kind)){
        if(typeof loadInventory === "function") loadInventory(); 
        if(typeof loadHistory === "function") loadHistory(); 
      }

      // ì‹¤íŒ¨ ëª©ë¡ ì½˜ì†” ì¶œë ¥
      if(data.failed && data.failed.length > 0) { console.error(`ì—‘ì…€ ì—…ë¡œë“œ ì‹¤íŒ¨ ëª©ë¡ (${kind}):`, data.failed); }
      if(data.failed_rows && data.failed_rows.length > 0) { console.error(`Location ì—…ë¡œë“œ ì‹¤íŒ¨ ëª©ë¡:`, data.failed_rows); }

      alert(msg);

    } catch (e) {
      box.textContent = "ì—…ë¡œë“œ ì˜¤ë¥˜: " + e.message;
      alert("ì—…ë¡œë“œ ì˜¤ë¥˜: " + e.message);
    }
  }

  // --- QR ìƒì„± ìœ í‹¸ ---
  function generateQR(){
    const data = document.getElementById("qr_data").value;
    const box = document.getElementById("qr_display");
    box.innerHTML = '';
    
    if(!data){
        box.textContent = "QR ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        return;
    }

    const size = 200;
    
    // QR Code ìƒì„±
    QRCode.toCanvas(
        data, 
        { errorCorrectionLevel: 'H', width: size, margin: 2 }, 
        (err, canvas) => {
            if(err){
                box.textContent = "QR ìƒì„± ì‹¤íŒ¨";
                console.error(err);
                return;
            }
            canvas.classList.add('qr-preview');
            box.appendChild(canvas);
        }
    );
  }
  
  // --- QR ìŠ¤ìº” ë¡œì§ ---
  let qrScanner = null;
  let qrContext = '';
  
  function startQrScan(type) {
    qrContext = type;
    const videoId = (type === 'in') ? 'qrVideoIn' : (type === 'out' ? 'qrVideoOut' : 'qrVideoMove');
    const statusId = (type === 'in') ? 'qrStatus' : (type === 'out' ? 'qrStatusOut' : 'qrStatusMove');
    const video = document.getElementById(videoId);
    const status = document.getElementById(statusId);
    // canvasëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°
    // const canvas = document.getElementById('qrCanvas'); 
    // const ctx = canvas.getContext('2d');

    if (qrScanner) stopQrScan();

    video.style.display = 'block';
    if(status) status.textContent = "ì¹´ë©”ë¼ ì‹œì‘ ì¤‘...";

    // Html5QrcodeReader ì‚¬ìš©
    const readerElementId = 'qrReaderTemp';
    if(!document.getElementById(readerElementId)){
        const div = document.createElement('div');
        div.id = readerElementId;
        div.style.display = 'none'; // ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìˆ¨ê¹€
        document.body.appendChild(div);
    }

    qrScanner = new Html5Qrcode(readerElementId);
    
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì‚¬ìš©
            const cameraId = devices.length > 1 ? devices[1].id : devices[0].id; // ë³´í†µ devices[1]ì´ í›„ë©´ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
            
            qrScanner.start(
                cameraId, 
                { fps: 10, qrbox: 250 }, 
                (decodedText, decodedResult) => {
                    handleQrText(decodedText);
                    stopQrScan();
                },
                (errorMessage) => {
                    // console.log(`QR Error: ${errorMessage}`);
                }
            ).then(() => {
                if(status) status.textContent = "QR ìŠ¤ìº” ì¤‘...";
                // ìŠ¤ìºë„ˆê°€ ì‹œì‘ë˜ë©´, ìˆ¨ê²¨ì§„ ë¦¬ë”ì˜ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ë³µì‚¬í•˜ì—¬ í‘œì‹œìš© ë¹„ë””ì˜¤ ìš”ì†Œì— ì—°ê²°
                const actualVideoElement = document.getElementById(readerElementId).querySelector('video');
                if (actualVideoElement) {
                    video.srcObject = actualVideoElement.srcObject;
                    video.style.display = 'block';
                }
            }).catch(err => {
                if(status) status.textContent = "ì¹´ë©”ë¼ ì‹œì‘ ì˜¤ë¥˜: " + err;
                console.error("QR Start Error:", err);
            });
        } else {
            if(status) status.textContent = "ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
    }).catch(err => {
        if(status) status.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + err;
        console.error("Camera Access Error:", err);
    });

  }

  function stopQrScan() {
    if (qrScanner) {
        // Html5Qrcode.stop()ì€ ë¹„ë™ê¸°ì´ë¯€ë¡œ .then().catch() ì‚¬ìš©
        qrScanner.stop().catch(err => console.log("QR Stop Error:", err));
        qrScanner = null;
    }
    
    // ëª¨ë“  video ìš”ì†Œ ì´ˆê¸°í™”
    document.getElementById("qrVideoIn").style.display = 'none';
    document.getElementById("qrVideoOut").style.display = 'none';
    document.getElementById("qrVideoMove").style.display = 'none';
    
    // srcObjectë¥¼ nullë¡œ ì„¤ì •í•˜ì—¬ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ í•´ì œ
    const videoIn = document.getElementById("qrVideoIn");
    const videoOut = document.getElementById("qrVideoOut");
    const videoMove = document.getElementById("qrVideoMove");
    if(videoIn.srcObject) videoIn.srcObject.getTracks().forEach(track => track.stop());
    if(videoOut.srcObject) videoOut.srcObject.getTracks().forEach(track => track.stop());
    if(videoMove.srcObject) videoMove.srcObject.getTracks().forEach(track => track.stop());
    
    document.getElementById("qrVideoIn").srcObject = null;
    document.getElementById("qrVideoOut").srcObject = null;
    document.getElementById("qrVideoMove").srcObject = null;
    
    if(document.getElementById("qrStatus")) document.getElementById("qrStatus").textContent = "ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...";
    if(document.getElementById("qrStatusOut")) document.getElementById("qrStatusOut").textContent = "ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...";
    if(document.getElementById("qrStatusMove")) document.getElementById("qrStatusMove").textContent = "ì¹´ë©”ë¼ ëŒ€ê¸°ì¤‘...";
  }


  function handleQrText(text){
    const obj = {};
    text.split(";").forEach(part=>{
      const [k,v] = part.split("=");
      if(!k || !v) return;
      obj[k.trim().toUpperCase()] = v.trim();
    });

    if(qrContext === "in"){
      if(obj.ITEM) in_item_code.value = obj.ITEM;
      if(obj.WH)   in_wh.value = obj.WH;
      if(obj.LOC)  in_loc.value = obj.LOC;
      if(obj.LOT)  in_lot.value = obj.LOT; // LOT ìˆ˜ê¸° ì…ë ¥ í•„ë“œì— ê°’ ì…ë ¥
      if(obj.QTY)  in_qty.value = obj.QTY;
      fillItemName(in_item_code, in_item_name);
      loadInventoryFilters(in_item_code.value, 'in'); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
      alert("ğŸ“¦ QR ì…ê³  ì •ë³´ ìë™ ì…ë ¥");
    }else if(qrContext === "out"){
      if(obj.ITEM) out_item_code.value = obj.ITEM;
      if(obj.WH)   out_wh.value = obj.WH;
      if(obj.LOC)  out_loc.value = obj.LOC;
      if(obj.LOT)  out_lot.value = obj.LOT;
      if(obj.QTY)  out_qty.value = obj.QTY;
      fillItemName(out_item_code, out_item_name);
      loadInventoryFilters(out_item_code.value, 'out'); // ë“œë¡­ë‹¤ìš´ ê°±ì‹  ë° í˜„ì¬ê³  ë¡œë“œ
      alert("ğŸšš QR ì¶œê³  ì •ë³´ ìë™ ì…ë ¥");
    }else if(qrContext === "move"){
      if(obj.ITEM) mv_item_code.value = obj.ITEM;
      if(obj.WHF)  mv_wh_from.value = obj.WHF;
      if(obj.LOCF) mv_loc_from.value = obj.LOCF;
      if(obj.WHT)  mv_wh_to.value = obj.WHT;
      if(obj.LOCT) mv_loc_to.value = obj.LOCT;
      if(obj.LOT)  mv_lot.value = obj.LOT;
      if(obj.QTY)  mv_qty.value = obj.QTY;
      fillItemName(mv_item_code, mv_item_name);
      loadInventoryFilters(mv_item_code.value, 'move'); // ë“œë¡­ë‹¤ìš´ ê°±ì‹  ë° í˜„ì¬ê³  ë¡œë“œ
      alert("ğŸ”„ QR ì´ë™ ì •ë³´ ìë™ ì…ë ¥");
    }
  }

  // ì´ˆê¸°
  window.onload = function() {
    openTab("dashboard");
    // ì´ˆê¸° ë“œë¡­ë‹¤ìš´ ì•ˆë‚´ ë¬¸êµ¬ ì„¤ì • (in_lotì€ inputìœ¼ë¡œ ë³€ê²½ë˜ì–´ ì œì™¸)
    clearDropdowns(in_wh, in_loc, 'ì°½ê³ /ë¡œì¼€ì´ì…˜'); 
    clearDropdowns(out_wh, out_loc, out_lot, 'ì°½ê³ /ë¡œì¼€ì´ì…˜/LOT');
    clearDropdowns(mv_wh_from, mv_loc_from, mv_lot, 'ì¶œê³ ì§€/LOT');
  }
</script>

<div id="qrReaderTemp" style="display:none;"></div>
</body>
</html>
