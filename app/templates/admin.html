{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h3>ğŸ› ï¸ ê´€ë¦¬ì ì‘ì—… ë¡œê·¸ (ë¡¤ë°± ê´€ë¦¬)</h3>
  <p class="text-danger">
    âš ï¸ ê´€ë¦¬ì ì „ìš© í™”ë©´ì…ë‹ˆë‹¤. ë¡¤ë°± ì‹œ ì‹¤ì œ ì¬ê³ ê°€ ë³€ê²½ë©ë‹ˆë‹¤.
  </p>

  <div class="table-responsive">
    <table class="table table-bordered table-hover mt-3 align-middle">
      <thead class="table-dark">
        <tr>
          <th>ì‹œê°„</th>
          <th>êµ¬ë¶„</th>
          <th>ì°½ê³ </th>
          <th>ë¡œì¼€ì´ì…˜</th>
          <th>í’ˆë²ˆ</th>
          <th>LOT</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ë¹„ê³ </th>
          <th>ê¸°ëŠ¥</th>
        </tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>
  </div>
</div>

<script>
async function loadLogs() {
  const res = await fetch('/api/admin/logs');
  const logs = await res.json();

  const html = logs.map(log => {
    let badge = "bg-secondary";
    if (log.tx_type === "IN") badge = "bg-primary";
    if (log.tx_type === "OUT") badge = "bg-danger";
    if (log.tx_type === "MOVE") badge = "bg-warning text-dark";

    return `
      <tr>
        <td>${log.created_at}</td>
        <td><span class="badge ${badge}">${log.tx_type}</span></td>
        <td>${log.warehouse}</td>
        <td>${log.location}</td>
        <td><b>${log.item_code}</b></td>
        <td>${log.lot_no}</td>
        <td class="text-end">${log.qty}</td>
        <td>${log.remark || ""}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger"
            onclick="rollback(${log.id}, '${log.tx_type}')">
            ë¡¤ë°±
          </button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("logTable").innerHTML = html;
}

async function rollback(id, type) {
  let msg = "ì´ ì‘ì—…ì„ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
  if (type === "MOVE") {
    msg = "âš ï¸ ì´ë™ ì‘ì—…ì…ë‹ˆë‹¤.\nì¶œë°œ/ë„ì°© ì¬ê³ ê°€ ëª¨ë‘ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.\nì§„í–‰í• ê¹Œìš”?";
  }

  if (!confirm(msg)) return;

  const res = await fetch(`/api/admin/rollback/${id}`, {
    method: "POST"
  });

  if (res.ok) {
    alert("âœ… ë¡¤ë°± ì™„ë£Œ");
    loadLogs();
  } else {
    alert("âŒ ë¡¤ë°± ì‹¤íŒ¨");
  }
}

loadLogs();
</script>

{% endblock %}
