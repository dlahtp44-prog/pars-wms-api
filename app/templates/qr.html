{% extends "base.html" %}
{% block content %}

<h2 style="margin:0 0 10px 0;">ğŸ“· QR ìŠ¤ìº”</h2>

<div style="display:grid;gap:10px;max-width:900px;">
  <video id="preview" playsinline style="width:100%;max-height:320px;background:#000;border-radius:12px;"></video>

  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <input id="qr" placeholder="QR í…ìŠ¤íŠ¸(ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥)"
      style="flex:1;min-width:220px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
    <button onclick="scan()" style="padding:10px 14px;border:none;border-radius:10px;background:#111827;color:#fff;">ì¡°íšŒ</button>
    <button onclick="startCamera()" style="padding:10px 14px;border:none;border-radius:10px;background:#2563eb;color:#fff;">ì¹´ë©”ë¼ ì‹œì‘</button>
    <button onclick="stopCamera()" style="padding:10px 14px;border:none;border-radius:10px;background:#ef4444;color:#fff;">ì¹´ë©”ë¼ ì¢…ë£Œ</button>
  </div>

  <div id="status" style="color:#6b7280;font-size:13px;"></div>
  <div id="result"></div>
</div>

<!-- âœ… QR ë””ì½”ë”(ê°€ë³ê³  ëª¨ë°”ì¼ ì˜ë¨) -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
let codeReader = null;
let currentStream = null;

function setStatus(msg){ document.getElementById("status").innerText = msg || ""; }

async function startCamera(){
  try{
    if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

    // ì¹´ë©”ë¼ ê¶Œí•œ + í›„ë©´ì¹´ë©”ë¼ ìš°ì„ 
    setStatus("ì¹´ë©”ë¼ ì‹œì‘ì¤‘...");
    await stopCamera();

    const video = document.getElementById("preview");

    // ZXingì´ ì•Œì•„ì„œ device ì„ íƒí•´ì¤Œ (ëª¨ë°”ì¼ì€ ëŒ€ì²´ë¡œ í›„ë©´)
    codeReader.decodeFromVideoDevice(null, video, (result, err) => {
      if(result){
        const text = result.getText();
        document.getElementById("qr").value = text;
        setStatus("ìŠ¤ìº”ë¨: " + text);
        scan(); // ìŠ¤ìº” ì¦‰ì‹œ ì¡°íšŒ
      }
    });

    setStatus("ì¹´ë©”ë¼ ì‹¤í–‰ì¤‘(QRì„ í™”ë©´ì— ë³´ì—¬ì£¼ì„¸ìš”).");
  }catch(e){
    console.error(e);
    setStatus("ì¹´ë©”ë¼ ì‹¤í–‰ ì‹¤íŒ¨: " + e);
    alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.");
  }
}

async function stopCamera(){
  try{
    if(codeReader){
      codeReader.reset();
    }
  }catch(e){}

  // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ stream ì§ì ‘ ì¢…ë£Œ í•„ìš”
  const video = document.getElementById("preview");
  if(video && video.srcObject){
    const tracks = video.srcObject.getTracks();
    tracks.forEach(t => t.stop());
    video.srcObject = null;
  }
  setStatus("ì¹´ë©”ë¼ ì¢…ë£Œë¨");
}

async function scan(){
  const q = document.getElementById("qr").value.trim();
  if(!q) return;

  setStatus("ì¡°íšŒì¤‘...");
  const res = await fetch(`/api/qr-search?q=${encodeURIComponent(q)}`);
  if(!res.ok){
    setStatus("ì¡°íšŒ ì‹¤íŒ¨");
    document.getElementById("result").innerHTML = "<p>ì¡°íšŒ API ì˜¤ë¥˜</p>";
    return;
  }

  const rows = await res.json();
  let html = "";

  if(!rows || rows.length === 0){
    html = "<p>ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  } else {
    html += `
    <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fff;">
    <table style="width:100%;border-collapse:collapse;min-width:760px;">
      <thead>
        <tr style="background:#ffeb3b;">
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">ì¥ì†Œ</th>
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">í’ˆë²ˆ</th>
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">LOT</th>
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">ë¡œì¼€ì´ì…˜</th>
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">ìˆ˜ëŸ‰</th>
          <th style="padding:10px;border-bottom:1px solid #e5e7eb;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
    `;

    for(const r of rows){
      const item = encodeURIComponent(r.item_code || "");
      const lot  = encodeURIComponent(r.lot_no || "");
      const loc  = encodeURIComponent(r.location || "");

      html += `
      <tr>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${r.location_name || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${r.item_code || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${r.lot_no || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;">${r.location || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;font-weight:800;">${r.qty ?? ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f1f5f9;">
          <button style="padding:8px 10px;border:none;border-radius:10px;background:#111827;color:#fff;cursor:pointer;"
            onclick="goOutbound('${item}','${lot}','${loc}')">ì¶œê³ </button>
          <button style="padding:8px 10px;border:none;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer;margin-left:6px;"
            onclick="goMove('${item}','${lot}','${loc}')">ì´ë™</button>
        </td>
      </tr>
      `;
    }
    html += "</tbody></table></div>";
  }

  document.getElementById("result").innerHTML = html;
  setStatus("ì¡°íšŒ ì™„ë£Œ");
}

/**
 * âœ… ì—¬ê¸° URLì€ ë„¤ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ì¶° í†µì¼í•´ì•¼ í•¨
 * - ë©”ì¸ í˜ì´ì§€ê°€ /outbound-page /move-page ë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
 * - ì‘ì—…ì í˜ì´ì§€ê°€ /worker/outbound /worker/move ë¼ë©´ ì•„ë˜ë¥¼ ê·¸ê±¸ë¡œ ë°”ê¿”ì•¼ í•¨
 */
function goOutbound(item, lot, loc){
  location.href = `/outbound-page?item_code=${item}&lot_no=${lot}&location=${loc}`;
}
function goMove(item, lot, loc){
  location.href = `/move-page?item_code=${item}&lot_no=${lot}&from_location=${loc}`;
}

// í˜ì´ì§€ ë“¤ì–´ì˜¤ë©´ ìë™ ì‹œì‘(ì›í•˜ë©´ ëŒ ìˆ˜ ìˆìŒ)
startCamera();
</script>

{% endblock %}
