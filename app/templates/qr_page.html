{% extends "worker_base.html" %}
{% block worker_content %}

<div class="card">
  <div class="h2">ğŸ“· QR ìŠ¤ìº”</div>

  <!-- ìˆ˜ë™ ì…ë ¥ -->
  <div class="form">
    <input id="manual_qr" placeholder="QR ë‚´ìš© ì§ì ‘ ì…ë ¥ (item_code=...)" />
    <button class="btn" onclick="manualSearch()">ì§ì ‘ ì¡°íšŒ</button>
  </div>

  <div class="hr"></div>

  <!-- ì¹´ë©”ë¼ -->
  <div id="reader" style="width:100%; max-width:360px;"></div>

  <div class="row">
    <select id="action">
      <option value="IN">ì…ê³ </option>
      <option value="OUT">ì¶œê³ </option>
      <option value="MOVE">ì´ë™</option>
    </select>
    <button class="btn primary" onclick="startScan()">ì¹´ë©”ë¼ ì‹œì‘</button>
    <button class="btn" onclick="stopScan()">ì¤‘ì§€</button>
  </div>

  <div id="msg" class="muted"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qrScanner = null;

/* QR ë¬¸ìì—´ â†’ ê°ì²´ ë³€í™˜ */
function parseQR(text){
  const params = new URLSearchParams(text);
  const o = {};
  for(const [k,v] of params.entries()) o[k] = v;
  return o;
}

/* ì‹¤ì œ ì²˜ë¦¬ */
async function processQR(text){
  try{
    const data = parseQR(text);
    const action = document.getElementById("action").value;

    const body = {
      action,
      warehouse: data.warehouse || "MAIN",
      location: data.location || "",
      from_location: data.from_location || "",
      to_location: data.to_location || "",
      item_code: data.item_code,
      item_name: data.item_name || "",
      lot_no: data.lot_no,
      spec: data.spec || "",
      qty: Number(data.qty || 0)
    };

    const res = await fetch("/api/qr/process", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });

    const d = await res.json();
    document.getElementById("msg").innerText =
      res.ok ? "âœ… ì²˜ë¦¬ ì™„ë£Œ" : "âŒ " + (d.detail || JSON.stringify(d));
  }catch(e){
    document.getElementById("msg").innerText = "âŒ QR íŒŒì‹± ì‹¤íŒ¨";
  }
}

/* ì¹´ë©”ë¼ ì‹œì‘ */
function startScan(){
  if(qrScanner) return;

  qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      stopScan();
      processQR(decodedText);
    },
    (err) => {}
  ).catch(err=>{
    document.getElementById("msg").innerText =
      "âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨ (ê¶Œí•œ í™•ì¸)";
  });
}

/* ì¹´ë©”ë¼ ì¤‘ì§€ */
function stopScan(){
  if(!qrScanner) return;
  qrScanner.stop().then(()=>{
    qrScanner.clear();
    qrScanner = null;
  });
}

/* ìˆ˜ë™ ì…ë ¥ */
function manualSearch(){
  const v = document.getElementById("manual_qr").value.trim();
  if(!v){
    alert("QR ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }
  processQR(v);
}
</script>

{% endblock %}
