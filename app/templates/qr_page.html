{% extends "worker_base.html" %}
{% block worker_content %}
<div class="card">
  <div class="h2">ğŸ“· QR ìŠ¤ìº”</div>

  <p class="muted">QR ë‚´ìš©ì€ â€œì¿¼ë¦¬ìŠ¤íŠ¸ë§â€ í˜•íƒœë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ì˜ˆ)</p>
  <code class="code">item_code=728750&lot_no=H5415&location=D01-01&qty=10&action=IN</code>

  <div id="reader" style="width:100%;"></div>
  <div class="row">
    <select id="action">
      <option value="IN">ì…ê³ (IN)</option>
      <option value="OUT">ì¶œê³ (OUT)</option>
      <option value="MOVE">ì´ë™(MOVE)</option>
    </select>
    <button class="btn" onclick="startScan()">ìŠ¤ìº” ì‹œì‘</button>
    <button class="btn" onclick="stopScan()">ì¤‘ì§€</button>
  </div>

  <div id="result" class="muted"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qr;

function parseQS(text){
  // QRì´ "a=b&c=d" í˜•íƒœë©´ íŒŒì‹±
  const params = new URLSearchParams(text.trim());
  const o = {};
  for(const [k,v] of params.entries()) o[k]=v;
  return o;
}

async function handleQR(text){
  const data = parseQS(text);
  const action = (data.action || document.getElementById('action').value).toUpperCase();
  const body = {
    action,
    warehouse: data.warehouse || "MAIN",
    location: data.location || "",
    from_location: data.from_location || "",
    to_location: data.to_location || "",
    brand: data.brand || "",
    item_code: data.item_code || "",
    item_name: data.item_name || "",
    lot_no: data.lot_no || "",
    spec: data.spec || "",
    qty: parseFloat(data.qty || "0")
  };

  const res = await fetch('/api/qr/process', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const d = await res.json();
  document.getElementById('result').innerText = res.ok ? ("âœ… ì²˜ë¦¬ì™„ë£Œ: " + text) : ("âŒ " + (d.detail || JSON.stringify(d)));
}

function startScan(){
  if(qr) return;
  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => { stopScan(); handleQR(decodedText); },
    () => {}
  );
}
function stopScan(){
  if(!qr) return;
  qr.stop().then(()=>{ qr.clear(); qr=null; }).catch(()=>{});
}
</script>
{% endblock %}
