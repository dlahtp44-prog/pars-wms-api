{% extends "worker_base.html" %}
{% block content %}

<h2>ğŸ“· QR ì´ë™ ì²˜ë¦¬</h2>

<p id="state">â‘  ì œí’ˆ QRì„ ìŠ¤ìº”í•˜ì„¸ìš”</p>
<div id="reader" style="width:100%;max-width:360px"></div>

<button onclick="start()">ğŸ“¸ ì¹´ë©”ë¼ ì‹œì‘</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let step = 1;
let item = {};
let scanner;

function parseQR(txt){
  const p = new URLSearchParams(txt);
  const o = {};
  for(const [k,v] of p.entries()) o[k]=v;
  return o;
}

function start(){
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScan
  );
}

async function onScan(txt){
  const d = parseQR(txt);

  if(step===1 && d.type==="ITEM"){
    item = d;
    step = 2;
    document.getElementById("state").innerText =
      "â‘¡ ëª©ì ì§€ ë¡œì¼€ì´ì…˜ QRì„ ìŠ¤ìº”í•˜ì„¸ìš”";
    return;
  }

  if(step===2 && d.type==="LOCATION"){
    scanner.stop();

    await fetch("/api/qr/process", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        from_location: item.location || "TEMP",
        to_location: d.location,
        item_code: item.item_code,
        lot_no: item.lot_no,
        qty: Number(item.qty)
      })
    });

    document.getElementById("state").innerText =
      "âœ… ì´ë™ ì™„ë£Œ";
  }
}
</script>

{% endblock %}
