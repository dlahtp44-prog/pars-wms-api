{% extends "worker_base.html" %}
{% block worker_content %}

<h2>ğŸ“· QR ìŠ¤ìº”</h2>

<div id="reader" style="width:100%;max-width:360px;"></div>
<p id="msg"></p>

<select id="action">
  <option value="IN">ì…ê³ </option>
  <option value="OUT">ì¶œê³ </option>
  <option value="MOVE">ì´ë™</option>
</select>

<button onclick="startScan()">ì¹´ë©”ë¼ ì‹œì‘</button>
<button onclick="stopScan()">ì¤‘ì§€</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let scanner = null;

async function startScan(){
  if(scanner) return;

  scanner = new Html5Qrcode("reader");

  const cameras = await Html5Qrcode.getCameras();
  const back = cameras.find(c =>
    c.label.toLowerCase().includes("back")
    || c.label.toLowerCase().includes("rear")
  ) || cameras[0];

  await scanner.start(
    back.id,
    { fps: 10, qrbox: 250 },
    async (text)=>{
      stopScan();
      await fetch("/api/qr/process",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(parse(text))
      });
      document.getElementById("msg").innerText="âœ… ì²˜ë¦¬ ì™„ë£Œ";
    }
  );
}

function stopScan(){
  if(!scanner) return;
  scanner.stop().then(()=>{
    scanner.clear();
    scanner = null;
  });
}

function parse(text){
  const p = new URLSearchParams(text);
  const o = {};
  for(const [k,v] of p.entries()) o[k]=v;
  o.action = document.getElementById("action").value;
  return o;
}
</script>

{% endblock %}
