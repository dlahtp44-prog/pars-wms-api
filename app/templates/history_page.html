{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">ğŸ“œ ì‘ì—… ì´ë ¥ (History)</h2>
        <button class="btn btn-success shadow-sm" onclick="location.href='/api/export_excel/history'">
            ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        </button>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" style="min-width: 1000px;">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-4 py-3">ì¼ì‹œ</th>
                            <th class="px-4 py-3">ìœ í˜•</th>
                            <th class="px-4 py-3">í’ˆëª©ì½”ë“œ</th>
                            <th class="px-4 py-3 text-info">ê·œê²©(Spec)</th>
                            <th class="px-4 py-3">ìˆ˜ëŸ‰</th>
                            <th class="px-4 py-3">ë¡œì¼€ì´ì…˜</th>
                            <th class="px-4 py-3">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
async function loadHistory() {
    try {
        // API í˜¸ì¶œ (ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ì™€ ì—°ê²°)
        const res = await fetch('/api/history');
        if (!res.ok) throw new Error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        
        const data = await res.json();
        const list = document.getElementById('history-list');
        list.innerHTML = '';

        data.forEach(h => {
            const tr = document.createElement('tr');
            tr.className = "align-middle border-bottom";
            
            // 1. ìœ í˜•ë³„ ë°°ì§€(Badge) ìƒ‰ìƒ ì²˜ë¦¬
            let typeTag = `<span class="badge bg-secondary">${h.tx_type}</span>`;
            if(h.tx_type === 'IN') typeTag = `<span class="badge bg-success-subtle text-success border border-success-subtle px-2">ì…ê³ </span>`;
            if(h.tx_type === 'OUT') typeTag = `<span class="badge bg-danger-subtle text-danger border border-danger-subtle px-2">ì¶œê³ </span>`;
            if(h.tx_type === 'MOVE') typeTag = `<span class="badge bg-primary-subtle text-primary border border-primary-subtle px-2">ì´ë™</span>`;

            // 2. ë¡œì¼€ì´ì…˜ ì •ë³´ ì²˜ë¦¬ (ì´ë™ì¼ ê²½ìš° í™”ì‚´í‘œ í‘œì‹œ)
            let locInfo = `<span class="badge bg-light text-dark border">${h.location || '-'}</span>`;
            if(h.tx_type === 'MOVE') {
                locInfo = `<span class="text-muted">${h.from_location || '-'}</span> â” <span class="fw-bold">${h.to_location || '-'}</span>`;
            }

            // 3. í–‰ êµ¬ì„± (ê·œê²© ë°ì´í„° row.spec ì¶”ê°€)
            tr.innerHTML = `
                <td class="px-4 py-3 text-muted" style="font-size: 0.85rem;">
                    ${h.created_at ? h.created_at.replace('T', ' ').substring(0, 16) : '-'}
                </td>
                <td class="px-4 py-3">${typeTag}</td>
                <td class="px-4 py-3">
                    <div class="fw-bold text-dark">${h.item_code}</div>
                    <small class="text-muted">${h.item_name || ''}</small>
                </td>
                <td class="px-4 py-3 text-info font-monospace">${h.spec || '-'}</td>
                <td class="px-4 py-3 fw-bold ${h.tx_type === 'OUT' ? 'text-danger' : 'text-primary'}">
                    ${h.tx_type === 'OUT' ? '-' : '+'}${h.qty.toLocaleString()}
                </td>
                <td class="px-4 py-3">${locInfo}</td>
                <td class="px-4 py-3 text-muted" style="font-size: 0.8rem;">${h.remark || ''}</td>
            `;
            list.appendChild(tr);
        });
    } catch (e) {
        console.error("ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:", e);
        document.getElementById('history-list').innerHTML = 
            `<tr><td colspan="7" class="text-center py-5 text-danger font-bold">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', loadHistory);
</script>

<style>
    /* í…Œì´ë¸” ê°€ë…ì„±ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¡°ì • */
    .table thead th {
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: -0.02em;
    }
    .badge {
        font-weight: 500;
    }
</style>
{% endblock %}
